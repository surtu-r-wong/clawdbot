---
name: postgres-query
description: PostgreSQL 数据库查询助手。支持查询行情数据、账户盈亏、多l-v头寸等。使用安全的参数化查询，防止 SQL 注入。

---

# PostgreSQL 数据库查询助手

这个技能用于安全地查询 PostgreSQL 数据库中的行情、盈亏、头寸等数据。

## 📑 目录

1. [使用方法](#使用方法)
2. [准备工作](#准备工作)
   2.1. [时间校准规则（第一步）](#时间校准规则第一步）
   2.2. [账户总权益计算规则](#账户总权益计算规则)
3. [计算方法](#计算方法)
   3.1. [当日账户盈亏](#当日账户盈亏)
   3.2. [当日持仓头寸盈亏](#当日持仓头寸盈亏)
   3.3. [头寸盈亏分析（累计）](#头寸盈亏分析累计)
4. [查询接口详细说明](#查询接口详细说明)
   4.1. [持仓查询](#持仓查询)
   4.2. [平仓记录查询](#平仓记录查询)
   4.3. [期货账户查询](#期货账户查询)
   4.4. [股票账户查询](#股票账户查询)
5. [实施步骤](#实施步骤)
6. [工具使用](#工具使用)
7. [故障排除](#故障排除)

---

## 使用方法

在对话中直接询问，例如：
- "昨天多l-v头寸赚了多少钱"
- "查询账户总盈亏"
- "今日行情汇总"
- "查询持有头寸列表"

我会直接执行查询并返回结果，不需要复杂的对话流程。

---

## 2. 准备工作

### 2.1. 时间校准规则（第一步）

**所有查询的第一步必须先校准时间！**

1. **获取当前日期**：执行 date +%Y-%m-%d 获取系统日期
2. **计算日期**：
   - "昨天" = 当前日期 - 1天
   - "今天" = 当前日期
   - "前天" = 当前日期 - 2天
3. **查询时使用计算后的日期，不要凭空推断！**

**示例**：
- 如果当前是 2026-01-29
- "昨天" = 2026-01-28
- "今天" = 2026-01-29
- "前天" = 2026-01-27

**⚠️ 永远不要凭记忆或推断日期，必须先执行 date 命令！**

### 2.2. 账户总权益计算规则

**⚠️ 所有涉及总权益的查询，必须合并计算期货账户和股票账户！**

### 计算方法
```
账户总权益 = 期货账户动态权益含期权 + 股票账户总资产
```

### 期货账户数据来源
- API接口: /api/futures/account
- 字段: 动态权益含期权
- 按账号分别查询后汇总

### 股票账户数据来源
- API接口: /api/stock/account
- 字段: 总资产
- 按账号分别查询后汇总

### 示例
```bash
# 查询期货账户
curl "http://100.67.45.63:8000/api/futures/account?trade_date=2026-01-28"

# 查询股票账户
curl "http://100.67.45.63:8000/api/stock/account?trade_date=2026-01-28"
```

**⚠️ 永远不要遗漏股票账户！**

---

## 3. 计算方法

### 3.1. 当日账户盈亏

**数据来源**:
- futures_account: 交易日期, 账号名称, 动态权益含期权, 入金, 出金
- stock_account: 交易日期, 账号名称, 总资产
- trading_calendar: calendar_date, sfe

**期货账户当日盈亏**:
```
当日盈亏 = (今日动态权益含期权 - 昨日动态权益含期权) - 今日入金 + 今日出金
当日盈亏百分比 = 当日盈亏 / 昨日动态权益含期权 × 100%
```

**股票账户当日盈亏**:
```
当日盈亏 = 今日总资产 - 昨日总资产
当日盈亏百分比 = 当日盈亏 / 昨日总资产 × 100%
```

**⚠️ 固定规则**：
- **永远使用上述公式计算当日盈亏**
- **盈亏百分比必须与盈亏金额一起提供，以昨日总权益为分母计算**
- 不要使用API返回的"今日账号盈亏"字段
- 必须同时查询今日和昨日数据计算
- 所有计算以用户给的公式为准

---

### 3.2. 当日持仓头寸盈亏

**数据来源**:
- position_table: 交易日期, 账号名称, 头寸名称, 浮动盈亏, 手续费（当前持仓）
- position_close_table: 交易日期, 账号名称, 头寸名称, 平仓盈亏, 手续费（平仓记录）
- futures_account: 账号名称, 期初权益, 动态权益（用于计算百分比）
- stock_account: 账号名称, 总资产（用于计算百分比）

**查询方法**：
```
当前持仓: GET /api/position
平仓记录: GET /api/position-close

参数:
- trade_date: 交易日期 (YYYY-MM-DD)
- account_name: 账号名称
- position_name: 头寸名称
- symbol: 标的代码
- start_date: 开始日期 (YYYY-MM-DD)
- end_date: 结束日期 (YYYY-MM-DD)
- limit: 返回条数 (默认1000，最大10000)
```

**计算方法**:
```
今日浮动盈亏 = SUM(浮动盈亏) - SUM(手续费)  -- 按账号、头寸名称分组
昨日浮动盈亏 = SUM(浮动盈亏) - SUM(手续费)  -- 按账号、头寸名称分组
今日平仓盈亏 = SUM(平仓盈亏) - SUM(手续费)  -- 按账号、头寸名称分组
浮动盈亏变化 = 今日浮动盈亏 - 昨日浮动盈亏
当日头寸盈亏 = 浮动盈亏变化 + 今日平仓盈亏
盈亏百分比 = 当日头寸盈亏 / 账户权益 × 100%
```

**⚠️ 重要**：
- **盈亏百分比必须与盈亏金额一起提供**
- 账户权益从 futures_account 表获取（期货用动态权益，股票用总资产）
- 按账号分别计算百分比

**⚠️ 固定计算规则**：
- **永远按上述公式计算**
- 浮动盈亏和手续费按账号、头寸名称分组后汇总
- 新开头寸：昨日浮动盈亏 = 0
- 当日无平仓：今日平仓盈亏 = 0
- **每次查询账户盈亏、头寸盈亏，都要列出具体金额和盈亏百分比**
- **盈亏百分比分母是账户期初权益**（不是昨日的动态权益）
- 账户期初权益从 futures_account 表获取（期货用期初权益，股票用总资产）
- 按账号分别列出金额和百分比，不要合并账户
- **筛选规则**: 计算头寸盈亏时，必须先筛选"头寸名称"，不能把不同头寸名称的数据混在一起计算
- **分组规则**: 同一头寸名称下有多个标的（如au2604和ag2604），要全部汇总计算

---

### 3.3. 头寸盈亏分析（累计）

**数据来源**:
- position_table: 账号名称, 头寸名称, 浮动盈亏（当前浮动盈亏）
- position_close_table: 账号名称, 头寸名称, 平仓盈亏（历史累计平仓盈亏）
- futures_account: 账号名称, 交易日期, 动态权益, 入金, 出金（计算累计净投入）

**计算方法**:
```
累计净投入 = 首日权益 + 累计入金 - 累计出金
当前浮动盈亏 = SUM(浮动盈亏)  -- 最新交易日，按头寸名称分组
历史平仓盈亏 = SUM(平仓盈亏)  -- 全部历史，按头寸名称分组
头寸总盈亏 = 当前浮动盈亏 + 历史平仓盈亏
收益率 = 头寸总盈亏 / 累计净投入 × 100%
```

---

## 4. 查询接口详细说明

### 4.1. 持仓查询

**请求方式**: GET

**接口路径**: /api/position

**支持参数**:
- trade_date: 交易日期 (YYYY-MM-DD)
- account_name: 账号名称
- position_name: 头寸名称
- symbol: 标的代码
- start_date: 开始日期 (YYYY-MM-DD)
- end_date: 结束日期 (YYYY-MM-DD)
- limit: 返回条数 (默认1000，最大10000)

**⚠️ 重要**:
- 浮动盈亏 字段是API返回的已经计算好的净浮动盈亏（包含多空方向）
- 计算头寸当日盈亏时，需要对比今日和昨日的浮动盈亏变化，再加上平仓盈亏
- 手续费已包含在API返回的 浮动盈亏 中，不需要单独扣除

**使用示例**:
- "查询所有持仓记录"
- "查询昨天的新开仓头寸"
- "查询账户xxx的持仓情况"
- "查询标的AAPL的持仓记录"
- "查询2024年1月的所有头寸"

### 4.2. 平仓记录查询

**请求方式**: GET

**接口路径**: /api/position-close

**支持参数**:
- trade_date: 交易日期 (YYYY-MM-DD)
- account_name: 账号名称
- position_name: 头寸名称
- start_date: 开始日期 (YYYY-MM-DD)
- end_date: 结束日期 (YYYY-MM-DD)
- limit: 返回条数 (默认1000，最大10000)

**返回字段**:
- id: 记录ID
- 交易日期: 交易日期
- 账号名称: 账号名称
- 资产类别: 资产类别
- 头寸类别: 头寸类别
- 头寸名称: 头寸名称
- 标的代码: 标的代码
- 标的名称: 标的名称
- 多空: 多空
- 总持仓: 平仓数量
- 开仓均价: 开仓均价
- 开仓成本: 开仓成本
- 保证金: 保证金
- 手续费: 手续费
- 平仓价格: 平仓价格
- 合约价值: 合约价值
- 平仓盈亏: 平仓盈亏
- 成交编号: 唯一键

### 4.3. 期货账户查询

**请求方式**: GET

**接口路径**: /api/futures/account

**支持参数**:
- trade_date: 交易日期 (YYYY-MM-DD)

**返回字段**:
- 交易日期: 交易日期
- 期货公司: 期货公司
- 账号: 账号
- 账号名称: 账号名称
- 账号备注: 账号备注
- 保证金比例: 保证金比例
- 冻结保证金: 冻结保证金
- 冻结手续费: 冻结手续费
- 风险度: 风险度
- 期初权益: 期初权益
- 动态权益: 动态权益
- 可用资金: 可用资金
- 手续费: 手续费
- 持仓盈亏: 持仓盈亏
- 平仓盈亏: 平仓盈亏
- 出入金净值: 出入金净值
- 当前保证金: 当前保证金
- 初始权益: 初始权益
- 合约价值: 合约价值
- 入金: 入金
- 出金: 出金
- 动态权益含期权: 动态权益含期权
- 起始日期: 起始日期
- 可取金额: 可取金额
- 交易日: 交易日
- 多单总市值: 多单总市值
- 空单总市值: 空单总市值
- 净持仓总市值: 净持仓总市值
- 申报费: 申报费
- 今日账号盈亏: 今日账号盈亏
- 权利金收支: 权利金收支
- 冻结权利金: 冻结权利金
- 风险度含期权: 风险度含期权
- 保证金仅期货: 保证金仅期货
- 账号状态: 账号状态
- 权利金市值: 权利金市值
- 结算动态权益[含期权]: 结算动态权益[含期权]
- 创建时间: 创建时间
- 更新时间: 更新时间

### 4.4. 股票账户查询

**请求方式**: GET

**接口路径**: /api/stock/account

**支持参数**:
- trade_date: 交易日期 (YYYY-MM-DD)

**返回字段**:
- 交易日期: 交易日期
- 账号名称: 账号名称
- 总资产: 总资产

---

## 5. 实施步骤

### 5.1. 查询执行流程

**触发语**：用postgres查询：[问题]

**执行流程**：
1. 显示：正在读取 skills/postgres-query/SKILL.md...
2. 执行：read skills/postgres-query/SKILL.md
3. 列出：相关公式
4. 查询：按公式要求查询数据
5. 验证：检查数据完整性
6. 计算：按公式计算
7. 警告：发现数据缺失或不一致时，立即警告
8. 输出：按账号分别列出金额和百分比

**目的**：确保每次计算都读取规则，不凭记忆操作

### 5.2. 数据完整性规则

**⚠️ 查询数据时必须验证完整性**

**检查项目**：
1. **查询前一个交易日**：
   - 往前查询，找到第一个有数据的交易日
   - 如果查询到空数据，必须警告用户

2. **验证查询结果**：
   - 检查每个账户是否都查询到了
   - 检查每个头寸是否都查询到了
   - 如果某个账户或头寸查询不到数据，必须警告用户

3. **对比不同时间点数据**：
   - 如果同一头寸在不同时间查询到的数据不一致（持仓数量、开仓成本等），必须警告用户

4. **累计计算时**：
   - 如果某一天没有数据，无法计算当天盈亏，必须警告用户
   - 不要假设或跳过缺失的数据

**警告格式**：
```
⚠️ 警告：[具体问题]

例如：
⚠️ 警告：查询2026-01-25数据时返回空结果，可能不是交易日
⚠️ 警告：朝晖多资产账户的多cu-ni头寸在2026-01-30查询到数据，但2026-01-29未查询到
⚠️ 警告：金穗1号账户的空ni头寸在不同日期查询到的浮动盈亏数据不一致，请检查
```

**⚠️ 任何时候发现数据缺失、不一致或无法计算，都必须警告用户，不要假设或跳过！**

---

## 6. 工具使用

### 6.1. Node.js 查询脚本

**位置**: /home/surtu/clawd/skills/postgres-query/query-position.js

**基本用法**:
```bash
# 查询所有持仓
node query-position.js

# 查询指定日期的持仓
node query-position.js --trade-date 2024-01-28

# 查询指定账户的持仓
node query-position.js --account-name account_001

# 查询指定时间范围的持仓
node query-position.js --start-date 2024-01-01 --end-date 2024-01-31

# 查询指定标的的持仓
node query-position.js --symbol AAPL

# 组合查询
node query-position.js --account-name account_001 --start-date 2024-01-01 --limit 50
```

### 6.2. 使用 curl 查询

**基本用法**:
```bash
# 查询所有持仓
curl "http://100.67.45.63:8000/api/position"

# 查询指定日期的持仓
curl "http://100.67.45.63:8000/api/position?trade_date=2024-01-28"

# 查询指定账户的持仓
curl "http://100.67.45.63:8000/api/position?account_name=account_001"

# 查询平仓记录
curl "http://100.67.45.63:8000/api/position-close?trade_date=2024-01-28"

# 查询期货账户
curl "http://100.67.45.63:8000/api/futures/account?trade_date=2024-01-28"

# 查询股票账户
curl "http://100.67.45.63:8000/api/stock/account?trade_date=2024-01-28"
```

---

## 7. 故障排除

### 7.1. 查询失败

如果查询失败：
1. 检查数据库连接配置
2. 确认 PostgreSQL 服务是否运行
3. 验证用户权限
4. 检查防火墙设置

### 7.2. 数据异常

如果返回数据异常：
1. 验证查询参数是否正确
2. 检查日期格式是否为 YYYY-MM-DD
3. 确认参数编码（中文需要 URL 编码）

---

## 8. 附录

### 8.1. 重要教训

- **每次计算前必须先读SKILL.md，不能凭记忆**
- **永远不要合并账户，每个账户用自己的权益和盈亏**
- **盈亏百分比分母是期初权益，不是昨日的动态权益**
- **每次查询都要列出具体金额和盈亏百分比**
- **使用动态权益含期权，不要用期初权益做分母**
- **时间查询必须先确认北京时间**
- **每次更新完必须立即提交到GitHub**
- **数据完整性：发现数据缺失或不一致，必须警告用户！**

### 8.2. 版本记录

- **创建日期**: 2026-01-27
- **最后更新**: 2026-02-09
- **版本**: 2.0 (重构版)
- **更新内容**: 重新组织文档结构，删除重复内容，增强可读性，添加章节编号和目录
