# PostgreSQL 查询技能更新日志

## 2026-01-29 - 固定计算规则（更新）

### 新增内容

1. **固定计算规则文档化**
   - 将当日头寸盈亏计算方法固化为标准流程
   - 添加多au-ag头寸计算示例（2026-01-28）
   - 明确分组规则：按账号、头寸名称分组
   - 永远按此方法计算，除非王小爷明确要求修改

2. **盈亏百分比计算**
   - **盈亏百分比必须与盈亏金额一起提供**
   - 公式：盈亏百分比 = 当日头寸盈亏 / 账户权益 × 100%
   - 从 `futures_account` 表获取账户权益（动态权益）
   - 按账号分别计算百分比

2. **计算公式（固定规则）**
   ```
   当日头寸盈亏 = 浮动盈亏变化 + 今日平仓盈亏
   浮动盈亏变化 = 今日浮动盈亏 - 昨日浮动盈亏
   今日浮动盈亏 = SUM(浮动盈亏) - SUM(手续费)
   今日平仓盈亏 = SUM(平仓盈亏) - SUM(手续费)
   ```

3. **实际计算示例**
   - 多au-ag头寸当日盈亏 = 109,179.98 元
   - 朝晖多资产: 54,534.98 元
   - 金穗1号: 54,645.00 元

---

## 2026-01-29 - 头寸持仓查询功能

### 新增内容

1. **头寸持仓查询接口集成**
   - 接口路径: `GET /api/position`
   - 基础URL: `http://100.67.45.63:8000`

2. **支持查询参数**
   - `trade_date`: 交易日期 (YYYY-MM-DD)
   - `account_name`: 账号名称
   - `position_name`: 头寸名称
   - `symbol`: 标的代码
   - `start_date`: 开始日期 (YYYY-MM-DD)
   - `end_date`: 结束日期 (YYYY-MM-DD)
   - `limit`: 返回条数 (默认1000，最大10000)

3. **返回数据字段**
   - `id`: 记录ID
   - `交易日期`: 交易日期
   - `账号名称`: 账户名称
   - `资产类别`: 资产类别（futures, stock, crypto等）
   - `头寸类别`: 头寸类别（单边/对冲）
   - `头寸名称`: 头寸名称
   - `标的代码`: 标的代码
   - `标的名称`: 标的名称
   - `多空`: 多空方向（多/空）
   - `总持仓`: 总持仓数量
   - `开仓均价`: 开仓平均价格
   - `开仓成本`: 开仓成本
   - `保证金`: 保证金金额
   - `手续费`: 手续费
   - `最新价`: 最新价格
   - `合约价值`: 合约价值
   - `浮动盈亏`: 浮动盈亏金额
   - `created_at`: 创建时间

### 文件清单

1. **SKILL.md** - 技能文档（已更新）
   - 添加了头寸持仓查询接口说明
   - 添加了 API 使用示例
   - 添加了脚本使用说明

2. **query-position.js** - 查询脚本（新建）
   - 支持命令行参数查询
   - 支持程序化调用
   - 完整的错误处理
   - 帮助文档

3. **README.md** - 本文件（新建）

### 使用示例

#### 命令行使用
```bash
# 查询所有持仓
node query-position.js

# 查询指定日期的持仓
node query-position.js --trade-date 2026-01-28

# 查询指定账户的持仓
node query-position.js --account-name "朝晖多资产-国海良时期货[2]"

# 查询指定标的的持仓
node query-position.js --symbol au2604

# 查询指定时间范围的持仓
node query-position.js --start-date 2026-01-01 --end-date 2026-01-31

# 组合查询
node query-position.js --account-name "朝晖多资产-国海良时期货[2]" --symbol au2604 --limit 5
```

#### 程序化调用
```javascript
const { queryPositions } = require('./query-position.js');

// 查询所有持仓
const allPositions = await queryPositions();

// 查询指定参数
const result = await queryPositions({
  account_name: '朝晖多资产-国海良时期货[2]',
  symbol: 'au2604',
  limit: 10
});

console.log(result);
```

### 测试结果

✅ 所有查询功能已测试通过
- 基础查询: 通过
- 按账号查询: 通过
- 按标的查询: 通过
- 按日期范围查询: 通过
- 组合查询: 通过

### 下一步计划

- 添加更多查询接口（如：账户盈亏、行情数据等）
- 添加数据导出功能（CSV, Excel）
- 添加数据可视化功能
- 添加定时查询和通知功能

---

*更新时间: 2026-01-29*
